#!/bin/sh
set -e

branch=upstream

tempdir="$(mktemp -d --tmpdir dotconfig-update-upstream.XXXXXXXXXX)"
trap 'rm -fr "$tempdir"' 0 1 2 13 15

export GIT_INDEX_FILE="$tempdir/index"

local_ref=refs/heads/"$branch"
if ! git show-ref --quiet --verify "$local_ref"; then
  local_ref=
fi

remote_ref=refs/remotes/origin/"$branch"
if ! git show-ref --quiet --verify "$remote_ref"; then
  remote_ref=
fi

if [ -n "$local_ref" ] && [ -n "$remote_ref" ]; then
  if [ "$(git show-ref --hash --verify "$local_ref")" != \
       "$(git show-ref --hash --verify "$remote_ref")" ]; then
    >&2 printf "%s does not match with %s, aborting\n" "$local_ref" "$remote_ref"
    exit 1
  fi
fi

parent_branch="${local_ref:-$remote_ref}"

# Do not initialize the index with the previous tree, since the script is going
# to add every file anyway.
#if [ -n "$parent_branch" ]; then
#  git ls-tree -r --full-name "$parent_branch" | git update-index --index-info
#fi

add_file() {
  local mode="$1"; shift
  local path="$1"; shift
  local localpath="$1"; shift

  printf "Adding %s (%s)\n" "$path" "$localpath"

  local filehash="$(git hash-object -w "$localpath")"
  printf "100%s %s %s\t%s\n" "$mode" blob "$filehash" "$path" |\
    git update-index --index-info
}

add_input() {
  local mode="$1"; shift
  local path="$1"; shift

  local tempfile="$(mktemp --tmpdir="$tempdir")"
  >"$tempfile" cat
  add_file "$mode" "$path" "$tempfile"
}

add_remote() {
  local mode="$1"; shift
  local path="$1"; shift
  local uri="$1"; shift

  printf "Downloading %s\n" "$uri"

  local tempfile="$(mktemp --tmpdir="$tempdir")"
  rm -f "$tempfile"
  wget -q -O "$tempfile" "$uri"

  add_file "$mode" "$path" "$tempfile"
}

do_commit() {
  local treehash="$(git write-tree)"

  if [ -n "$parent_branch" ] && \
     [ "$treehash" = "$(git rev-parse "$parent_branch":)" ]; then
    >&2 printf "No changes, aborting\n"
    return 1
  fi

  local changelog="$tempdir/changelog"

  >"$changelog" printf "Automatic commit by dotconfig-update-upstream\n"

  printf "Committing\n"

  local commithash
  if [ -n "$parent_branch" ]; then
    commithash="$(git commit-tree "$treehash" -p "$parent_branch" <"$changelog")"
  else
    commithash="$(git commit-tree "$treehash" <"$changelog")"
  fi

  git update-ref refs/heads/"$branch" "$commithash"
}

add_file 644 .bashrc /etc/skel/.bashrc
add_file 644 .config/awesome/rc.lua /etc/xdg/awesome/rc.lua
add_file 644 .config/awesome/theme.lua /usr/share/awesome/themes/default/theme.lua
add_file 644 .devscripts /usr/share/devscripts/conf.default
add_file 644 .mplayer/input.conf /etc/mplayer/input.conf

rodentbane_uri='http://git.glacicle.com/?p=awesome/rodentbane.git;a=blob_plain;f=rodentbane.lua;hb=HEAD'
shifty_uri='http://git.mercenariesguild.net/?p=awesome.git;a=blob_plain;f=lib/shifty.lua.in;hb=shifty-master'

add_remote 644 .config/awesome/rodentbane.lua "$rodentbane_uri"
add_remote 644 .config/awesome/shifty.lua "$shifty_uri"

printf "*\n" | add_input 644 .gitignore

do_commit

# vim:set et sw=2 sts=2:
